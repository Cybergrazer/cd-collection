<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CD Collection (MusicBrainz Edition)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root {
            --bg-main: #232323;
            --bg-light: #3a3a3a;
            --bg-dark: #1a1a1a;
            --text-light: #f0f0f0;
            --text-med: #bbb;
            --accent: #0088cc;
            --gold: #ffd700;
            --red: #c33;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-main);
            color: var(--text-light);
            margin: 0;
            padding: 20px;
        }
        h2, h3 {
            border-bottom: 2px solid var(--accent);
            padding-bottom: 5px;
            color: var(--text-light);
        }
        h3 {
            font-size: 1.2em;
            margin-top: 0;
            color: var(--gold);
        }
        button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin: 0 5px 5px 0;
            transition: background-color 0.2s, color 0.2s;
        }
        button:hover { background: #0099e6; }
        button:disabled { background: #555; cursor: not-allowed; }
        button.danger { background: var(--red); }
        button.danger:hover { background: #e64a4a; }

        button.needs-save {
            background: var(--gold);
            color: var(--bg-dark);
            font-weight: bold;
        }
        button.needs-save:hover {
            background: #ffea60;
        }

        input[type="text"], input[type="url"] {
            background: var(--bg-light);
            color: var(--text-light);
            border: 1px solid #555;
            padding: 10px;
            border-radius: 5px;
            font-size: 1em;
            margin-right: 5px;
        }
        input::placeholder { color: #888; }
        input[type="file"] { display: none; }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .main-layout {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 20px;
            margin-top: 20px;
        }
        #albumGrid {
            flex: 3;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            background: var(--bg-dark);
            padding: 20px;
            border-radius: 8px;
            min-height: 400px;
        }
        .album-card {
            background: var(--bg-light);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            position: relative;
        }
        .album-card.selected {
            border: 2px solid var(--gold);
            box-shadow: 0 0 15px var(--gold);
        }
        .album-card:hover { transform: translateY(-5px); }
        .album-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
            background: #555;
        }
        .card-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
            height: 36px; 
        }
        .card-text {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .title-text {
            font-size: 0.9em;
            font-weight: bold;
        }
        .artist-text {
            font-size: 0.8em;
            color: var(--text-med);
        }
        .card-link {
            flex-shrink: 0;
            margin-left: 5px;
            display: flex;
            align-items: center;
        }
        .card-logo {
            width: 18px;
            height: 18px;
            fill: var(--text-med);
            transition: fill 0.2s;
        }
        .card-link:hover .card-logo {
            fill: var(--accent);
        }
        
        .delete-icon {
            position: absolute;
            top: 5px;
            left: 5px;
            transform: none;
            z-index: 10;
            fill: var(--text-med);
            width: 20px;
            height: 20px;
            opacity: 0.6;
            cursor: pointer;
            transition: all 0.2s;
            padding: 4px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 4px;
        }
        .album-card:hover .delete-icon {
            opacity: 1.0;
        }
        .delete-icon:hover {
            fill: var(--red);
            transform: scale(1.1);
            background: rgba(0, 0, 0, 0.6);
        }
        
        #trackSidebar {
            flex: 1;
            min-width: 300px;
            background: var(--bg-dark);
            padding: 20px;
            border-radius: 8px;
            overflow-y: auto;
            position: sticky;
            top: 20px; 
            max-height: calc(100vh - 40px); 
        }

        #trackSidebar ol {
            padding-left: 25px;
            margin: 0;
        }
        #trackSidebar li {
            padding: 4px 0;
            color: var(--text-med);
        }
        .sidebar-date {
            color: #aaa;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        .panel {
            background: var(--bg-dark);
            padding: 15px 20px;
            border-radius: 8px;
        }
        .panel-row { display: flex; align-items: center; margin-bottom: 10px; }
        .panel-row label { margin-right: 10px; font-weight: bold; min-width: 100px; }
        #status {
            font-size: 1.1em;
            margin-top: 10px;
            min-height: 1.2em;
            color: var(--gold);
        }
        #failedLogBox {
            background: #201a12;
            color: #ffa;
            padding: 12px;
            border-radius: 5px;
            min-height: 48px;
            max-height: 160px;
            overflow-y: auto;
            font-size: 0.9em;
            border: 1px solid #333;
            margin-top: 10px;
        }
        
        #az-breadcrumb {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding-top: 10px;
        }
        .az-letter {
            background: var(--bg-light);
            color: var(--text-light);
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            transition: background 0.2s;
            user-select: none;
        }
        .az-letter:hover {
            background: var(--accent);
            color: white;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: var(--bg-light);
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.8em;
            font-weight: bold;
            color: var(--text-med);
            cursor: pointer;
        }
        .modal-close:hover {
            color: var(--text-light);
        }
        #modalImageGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .modal-image-item {
            background: var(--bg-dark);
            border-radius: 4px;
            overflow: hidden;
            border: 2px solid transparent;
            transition: border 0.2s;
        }
        .modal-image-item:hover {
            border: 2px solid var(--gold);
        }
        .modal-image-item img {
            width: 100%;
            object-fit: cover;
            height: 150px;
            cursor: pointer;
            display: block;
        }
        .modal-image-item p {
            font-size: 0.8em;
            color: var(--text-med);
            text-align: center;
            margin: 8px;
            padding: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #modalAlbumList {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .album-select-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--bg-dark);
            border-radius: 4px;
        }
        .album-select-item-info {
            display: flex;
            flex-direction: column;
        }
        .album-select-item-info strong {
            font-size: 1.1em;
            color: var(--text-light);
        }
        .album-select-item-info span {
            font-size: 0.9em;
            color: var(--text-med);
        }
        .album-select-item button {
            padding: 5px 10px;
            font-size: 0.9em;
            margin: 0;
        }
        
        .wiki-container {
            margin-top: 20px;
            border-top: 1px solid var(--bg-light);
            padding: 15px;
            background-color: white;
            color: black;
            border-radius: 8px; 
        }
        .wiki-header {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 10px;
        }
        .wiki-logo {
            width: 40px; 
            height: 40px;
        }
        .wiki-title {
            font-family: Georgia, 'Linux Libertine', 'Times New Roman', serif;
            font-size: 1.5em;
            font-weight: normal;
            color: black;
            margin-bottom: 0;
            text-align: left;
        }
        .wiki-container .wiki-link {
            display: block;
            text-align: center;
            margin-top: 15px;
            font-size: 0.9em;
            color: var(--accent);
            text-decoration: none;
        }
        .wiki-container .wiki-link:hover {
            text-decoration: underline;
        }

    </style>
</head>
<body>

    <div class="container">
        <h2>CD Collection</h2>

        <div class="panel">
            <h3>Google Sheet Import</h3>
            <div class="panel-row">
                <label for="sheetUrl">Public Sheet URL:</label>
                <input type="url" id="sheetUrl" size="60" placeholder="Paste your 'Publish to the web' .../pub?output=tsv link">
            </div>
            <button onclick="app.loadFromGoogleSheet()">1. Load from Google Sheet</button>
            <button onclick="app.processSheetQueue()">2. Find Album Info</button>
            <div id="status"></div>
        </div>

        <div class="panel">
            <h3>Manage Collection</h3>
            <div style="margin-bottom: 15px;">
                <input type="text" id="barcodeInput" placeholder="Scan or enter barcode...">
                <button onclick="app.barcodeSearch()">Search Barcode</button>
            </div>
            <div>
                <input type="text" id="artistInput" placeholder="Artist name">
                <input type="text" id="albumInput" placeholder="Album title">
                <button onclick="app.manualSearch()">Add Manually</button>
            </div>
            <div style="margin-top: 15px;">
                <button onclick="document.getElementById('csvInput').click()">Import from CSV</button>
                <button onclick="app.exportToCSV()">Export to CSV</button>
                <button onclick="document.getElementById('jsonInput').click()">Import from JSON</button>
                <button id="exportBtn" onclick="app.exportDB()">Export to JSON</button>
                <button id="updateImageBtn" onclick="app.showImageUpdater()" disabled>Update Image</button>
                <button id="deleteBtn" class="danger" onclick="app.deleteCurrentAlbum()" disabled>Delete Selected</button>
            </div>
        </div>
        
        <div class="panel">
            <h3>
                Artist A-Z
                <span id="albumCountTotal" style="float: right; font-size: 0.8em; font-weight: normal;">(Total: 0)</span>
            </h3>
            <div id="az-breadcrumb">
                </div>
        </div>
        
        <input type="file" id="csvInput" accept=".csv" onchange="app.handleCSVUpload(event)">
        <input type="file" id="jsonInput" accept=".json" onchange="app.handleJSONUpload(event)">

        <div class="main-layout">
            <div id="albumGrid">
                </div>
            <div id="trackSidebar">
                <h3>Select an Album</h3>
                <p>Click an album on the left to see its tracklist.</p>
            </div>
        </div>

        <div class="panel">
            <h3>Processing Log</h3>
            <button onclick="app.clearFailedLog()">Clear Failed Log</button>
            <div id="failedLogBox">(No failures yet)</div>
        </div>
    </div>

    <div id="imageModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="app.closeImageUpdater()">&times;</span>
            <h3>Select New Cover Art</h3>
            <div id="modalImageGrid">
                </div>
        </div>
    </div>

    <div id="albumSelectModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="app.closeAlbumSelectModal()">&times;</span>
            <h3 id="albumSelectTitle">Select Album</h3>
            <div id="modalAlbumList">
                </div>
        </div>
    </div>

<script>
// -----------------------------------------------------------------
//  MusicBrainz API Throttling & Fetching
// -----------------------------------------------------------------
const api = {
    requestQueue: [],
    isProcessing: false,
    REQUEST_DELAY: 1100, // 1.1 seconds to be safe

    throttledFetch(url, options = {}) {
        return new Promise((resolve, reject) => {
            this.requestQueue.push({ url, options, resolve, reject });
            if (!this.isProcessing) {
                this.processQueue();
            }
        });
    },

    async processQueue() {
        if (this.requestQueue.length === 0) {
            this.isProcessing = false;
            return;
        }

        this.isProcessing = true;
        const { url, options, resolve, reject } = this.requestQueue.shift();

        try {
            const response = await fetch(url, options);
            resolve(response);
        } catch (error) {
            reject(error);
        }

        setTimeout(() => this.processQueue(), this.REQUEST_DELAY);
    },

    async searchRelease(artist, title) {
        const query = `release:"${encodeURIComponent(title)}" AND artist:"${encodeURIComponent(artist)}"`;
        const url = `https://musicbrainz.org/ws/2/release/?query=${query}&fmt=json&limit=5`;
        
        try {
            const response = await this.throttledFetch(url);
            if (!response.ok) throw new Error(`MusicBrainz search failed: ${response.status}`);
            return await response.json();
        } catch (e) {
            console.error('searchRelease error:', e);
            throw e;
        }
    },

    /**
     * NEW: Searches MusicBrainz by barcode
     */
    async searchByBarcode(barcode) {
        const query = `barcode:${encodeURIComponent(barcode)}`;
        const url = `https://musicbrainz.org/ws/2/release/?query=${query}&fmt=json&limit=5`;
        try {
            const response = await this.throttledFetch(url);
            if (!response.ok) throw new Error(`MusicBrainz barcode search failed: ${response.status}`);
            return await response.json();
        } catch (e) {
            console.error('searchByBarcode error:', e);
            throw e;
        }
    },

    async searchReleasesByArtist(artistName) {
        const query = `artist:"${encodeURIComponent(artistName)}" AND (type:album OR type:ep) AND status:official`;
        const url = `https://musicbrainz.org/ws/2/release/?query=${query}&fmt=json&limit=25`;
        try {
            const response = await this.throttledFetch(url);
            if (!response.ok) throw new Error(`MusicBrainz artist search failed: ${response.status}`);
            return await response.json();
        } catch (e) {
            console.error('searchReleasesByArtist error:', e);
            throw e;
        }
    },

    async fetchReleaseDetails(mbid) {
        const url = `https://musicbrainz.org/ws/2/release/${mbid}?inc=recordings&fmt=json`;
        try {
            const response = await this.throttledFetch(url);
            if (!response.ok) throw new Error(`MusicBrainz tracks failed: ${response.status}`);
            return await response.json();
        } catch (e) {
            console.error('fetchReleaseDetails error:', e);
            throw e;
        }
    },

    async fetchCoverArtUrl(mbid) {
        const url = `https://coverartarchive.org/release/${mbid}/front`;
        try {
            const response = await this.throttledFetch(url, { method: 'HEAD' });
            if (response.ok || response.status === 307) {
                return url;
            }
            return null;
        } catch (e) {
            return null;
        }
    },

    async fetchReleaseImages(mbid) {
        const url = `https://coverartarchive.org/release/${mbid}`;
        try {
            const response = await this.throttledFetch(url);
            if (!response.ok) throw new Error(`Cover Art Archive search failed: ${response.status}`);
            const data = await response.json();
            return data.images || [];
        } catch (e) {
            console.error('fetchReleaseImages error:', e);
            return [];
        }
    },

    async searchItunes(artist, title) {
        const searchTerm = encodeURIComponent(`${artist} ${title}`);
        const url = `https://itunes.apple.com/search?term=${searchTerm}&entity=album&limit=10`;
        const proxyUrl = `https://cors-anywhere.herokuapp.com/${url}`;

        try {
            const response = await this.throttledFetch(proxyUrl);
            if (!response.ok) throw new Error(`iTunes search failed: ${response.status}`);
            return await response.json();
        } catch (e) {
            console.error('iTunes search error:', e);
            return { results: [] };
        }
    },
};

// -----------------------------------------------------------------
//  Main Application Logic
// -----------------------------------------------------------------
const app = {
    db: [],
    sheetQueue: [],
    selectedIdx: -1,
    isDirty: false,
    
    elements: {
        grid: document.getElementById('albumGrid'),
        sidebar: document.getElementById('trackSidebar'),
        status: document.getElementById('status'),
        failedLog: document.getElementById('failedLogBox'),
        deleteBtn: document.getElementById('deleteBtn'),
        sheetUrl: document.getElementById('sheetUrl'),
        artistInput: document.getElementById('artistInput'),
        albumInput: document.getElementById('albumInput'),
        barcodeInput: document.getElementById('barcodeInput'), // --- NEW ---
        updateImageBtn: document.getElementById('updateImageBtn'),
        imageModal: document.getElementById('imageModal'),
        modalImageGrid: document.getElementById('modalImageGrid'),
        albumSelectModal: document.getElementById('albumSelectModal'),
        modalAlbumList: document.getElementById('modalAlbumList'),
        exportBtn: document.getElementById('exportBtn'),
    },

    // --- Utility Functions ---
    setStatus(msg) { this.elements.status.textContent = msg; },
    logFailed(artist, title, reason) {
        const log = this.elements.failedLog;
        if (log.textContent.startsWith('(No')) {
            log.textContent = '';
        }
        log.textContent += `${artist} - ${title} [${reason}]\n`;
        log.scrollTop = log.scrollHeight;
    },
    clearFailedLog() { this.elements.failedLog.textContent = "(No failures yet)"; },
    
    sortDB() {
        this.db.sort((a, b) => {
            return (a.artist || '').localeCompare(b.artist || '') || (a.title || '').localeCompare(b.title || '');
        });
    },

    updateSaveStatus() {
        this.isDirty = true;
        this.elements.exportBtn.classList.add('needs-save');
    },
    
    // --- Core Data & UI Rendering ---
    renderGrid() {
        document.getElementById('albumCountTotal').textContent = `(Total: ${this.db.length})`;
        this.elements.grid.innerHTML = '';
        if (this.db.length === 0) {
            this.elements.grid.innerHTML = '<p style="color:#888;">No albums loaded.</p>';
        }
        
        this.db.forEach((album, idx) => {
            const card = document.createElement('div');
            card.className = 'album-card';
            card.onclick = () => this.selectAlbum(idx);
            
            if (idx === this.selectedIdx) {
                card.classList.add('selected');
            }
            
            const deleteBtn = document.createElement('div');
            deleteBtn.className = 'delete-icon';
            deleteBtn.title = 'Delete this album';
            deleteBtn.innerHTML = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>`;
            deleteBtn.onclick = (event) => {
                event.stopPropagation();
                this.deleteAlbumByIndex(idx);
            };
            card.appendChild(deleteBtn);
            
            const img = document.createElement('img');
            img.src = album.img || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
            if (!album.img) {
                img.alt = "(No cover art)";
            }
            card.appendChild(img);

            const tidalQuery = encodeURIComponent(`${album.artist} ${album.title}`);
            const tidalUrl = `https://tidal.com/search?q=${tidalQuery}&type=albums`;
            const amazonQuery = encodeURIComponent(`${album.artist} ${album.title}`);
            const amazonUrl = `https://music.amazon.com/search/${amazonQuery}`;

            const titleLine = document.createElement('div');
            titleLine.className = 'card-line title-line';
            titleLine.innerHTML = `
                <span class="card-text title-text">${album.title}</span>
                <a href="${tidalUrl}" class="card-link" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation();" title="Find on Tidal">
                    <svg class="card-logo" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 15V9h2v6H4zm3 2V7h2v10H7zm3-2V9h2v6h-2zm3 2V7h2v10h-2zm3-2V9h2v6h-2z"/>
                    </svg>
                </a>
            `;
            card.appendChild(titleLine);

            const artistLine = document.createElement('div');
            artistLine.className = 'card-line artist-line';
            artistLine.innerHTML = `
                <span class="card-text artist-text">${album.artist}</span>
                <a href="${amazonUrl}" class="card-link" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation();" title="Find on Amazon Music">
                    <svg class="card-logo" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM7.5 13.5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5S9.83 12 9 12s-1.5.67-1.5 1.5zm9 0c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5-.67-1.5-1.5-1.5-1.5.67-1.5 1.5zm-4.5 1.5c-2.33 0-4.31-1.46-5.11-3.5h10.22c-.8 2.04-2.78 3.5-5.11 3.5z"/>
                    </svg>
                </a>
            `;
            card.appendChild(artistLine);
            
            this.elements.grid.appendChild(card);
        });
    },

    renderSidebar() {
        if (this.selectedIdx === -1 || !this.db[this.selectedIdx]) {
            this.elements.sidebar.innerHTML = '<h3>Select an Album</h3><p>Click an album on the left to see its tracklist.</p>';
            this.elements.deleteBtn.disabled = true;
            this.elements.updateImageBtn.disabled = true;
            return;
        }

        const album = this.db[this.selectedIdx];
        let html = `<h3>${album.title}</h3><p style="margin:0; font-size: 1.1em;">${album.artist}</p>`;
        if (album.date) {
            html += `<div class="sidebar-date">Released: ${album.date}</div>`;
        }
        
        if (!album.tracks || album.tracks.length === 0) {
            html += '<p style="color:#f66; margin-top: 20px;">No track data found.</p>';
        } else {
            html += '<ol style="margin-top: 20px;">';
            album.tracks.forEach(t => {
                html += `<li>${t.number}. ${t.title}</li>`;
            });
            html += '</ol>';
        }

        const artistName = encodeURIComponent(album.artist.replace(/ /g, '_'));
        const wikiUrl = `https://en.wikipedia.org/wiki/${artistName}`;
        const wikiLogoUrl = "https://upload.wikimedia.org/wikipedia/commons/8/80/Wikipedia-logo-v2.svg";

        html += `
            <div class="wiki-container">
                <div class="wiki-header">
                    <img src="${wikiLogoUrl}" class="wiki-logo" alt="Wikipedia Logo">
                    <div class="wiki-title">${album.artist}</div>
                </div>
                <a href="${wikiUrl}" target="_blank" class="wiki-link" title="Click to open full article">
                    View article on Wikipedia
                </a>
            </div>
        `;
        
        this.elements.sidebar.innerHTML = html;
        this.elements.deleteBtn.disabled = false;
        this.elements.updateImageBtn.disabled = false;
    },

    selectAlbum(idx) {
        this.selectedIdx = idx;
        this.renderGrid();
        this.renderSidebar();
    },

    deleteCurrentAlbum() {
        if (this.selectedIdx === -1) return;
        this.deleteAlbumByIndex(this.selectedIdx);
    },

    deleteAlbumByIndex(idx) {
        const albumName = this.db[idx]?.title || "this album";
        if (confirm(`Do you want to remove "${albumName}"?`)) {
            this.db.splice(idx, 1);
            this.updateSaveStatus();

            if (this.selectedIdx === idx) {
                this.selectedIdx = -1;
            } else if (this.selectedIdx > idx) {
                this.selectedIdx--;
            }

            this.renderGrid();
            this.renderSidebar();
        }
    },

    // --- A-Z NAVIGATION FUNCTIONS ---
    jumpToLetter(letter) {
        let targetIndex = -1;

        if (letter === '#') {
            targetIndex = this.db.findIndex(album => {
                const firstChar = (album.artist || '').charAt(0).toUpperCase();
                return firstChar < 'A' || firstChar > 'Z';
            });
        } else {
            targetIndex = this.db.findIndex(album => {
                return (album.artist || '').toUpperCase().startsWith(letter);
            });
        }

        if (targetIndex === -1) {
            this.setStatus(`No artists found starting with "${letter}".`);
            return;
        }

        const targetCard = this.elements.grid.children[targetIndex];
        if (targetCard) {
            targetCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
            this.selectAlbum(targetIndex);
        }
    },
    
    populateAZNav() {
        const nav = document.getElementById('az-breadcrumb');
        if (!nav) return;
        const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ#".split('');
        let html = '';
        for (const char of letters) {
            html += `<span class="az-letter" onclick="app.jumpToLetter('${char}')">${char}</span>`;
        }
        nav.innerHTML = html;
    },

    // --- IMAGE MODAL FUNCTIONS ---
    getImageDimensions(url) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve({ width: img.naturalWidth, height: img.naturalHeight });
            img.onerror = () => reject('Could not load image');
            img.src = url;
        });
    },

    async showImageUpdater() {
        if (this.selectedIdx === -1) return;
        const album = this.db[this.selectedIdx];

        const grid = this.elements.modalImageGrid;
        grid.innerHTML = '<p>Loading images from Cover Art Archive and iTunes...</p>';
        this.elements.imageModal.style.display = 'flex';

        const caaPromise = album.id ? api.fetchReleaseImages(album.id) : Promise.resolve([]);
        const itunesPromise = api.searchItunes(album.artist, album.title);
        const results = await Promise.allSettled([caaPromise, itunesPromise]);
        
        const caaImages = (results[0].status === 'fulfilled') ? results[0].value : [];
        const itunesData = (results[1].status === 'fulfilled') ? results[1].value : { results: [] };

        let imagesToDisplay = [];
        if (album.img) {
            imagesToDisplay.push({ url: album.img, type: 'Current' });
        }
        caaImages.forEach(img => {
            if (img.image) imagesToDisplay.push({ url: img.image, type: 'CAA (Original)' });
            if (img.thumbnails.large) imagesToDisplay.push({ url: img.thumbnails.large, type: 'CAA (500px)' });
        });
        itunesData.results.forEach(item => {
            if (item.artworkUrl100) {
                const highResUrl = item.artworkUrl100.replace('100x100', '1200x1200');
                imagesToDisplay.push({ url: highResUrl, type: 'iTunes' });
            }
        });

        const uniqueImages = [];
        const seenUrls = new Set();
        for (const img of imagesToDisplay) {
            if (!seenUrls.has(img.url)) {
                uniqueImages.push(img);
                seenUrls.add(img.url);
            }
        }

        grid.innerHTML = '';
        if (uniqueImages.length === 0) {
            grid.innerHTML = '<p>No cover art found from any source.</p>';
            return;
        }

        uniqueImages.forEach(imgData => {
            const itemContainer = document.createElement('div');
            itemContainer.className = 'modal-image-item';
            const imgEl = document.createElement('img');
            imgEl.src = imgData.url;
            imgEl.onclick = () => this.updateAlbumImage(imgData.url);
            const infoEl = document.createElement('p');
            infoEl.textContent = `Loading... (${imgData.type})`;
            itemContainer.append(imgEl, infoEl);
            grid.appendChild(itemContainer);

            (async () => {
                try {
                    const dims = await this.getImageDimensions(imgData.url);
                    infoEl.textContent = `${dims.width} x ${dims.height} (${imgData.type})`;
                } catch (e) {
                    infoEl.textContent = `(${imgData.type} - Error loading)`;
                }
            })();
        });
    },

    closeImageUpdater() {
        this.elements.imageModal.style.display = 'none';
        this.elements.modalImageGrid.innerHTML = '';
    },

    updateAlbumImage(newImageUrl) {
        if (this.selectedIdx === -1) return;
        this.db[this.selectedIdx].img = newImageUrl;
        this.updateSaveStatus();
        this.closeImageUpdater();
        this.renderGrid();
    },

    // --- ALBUM SELECT MODAL FUNCTIONS ---
    async showAlbumSearch(artist) {
        const list = this.elements.modalAlbumList;
        document.getElementById('albumSelectTitle').textContent = `Select Album for "${artist}"`;
        list.innerHTML = '<p>Searching for albums...</p>';
        this.elements.albumSelectModal.style.display = 'flex';

        try {
            const data = await api.searchReleasesByArtist(artist);
            list.innerHTML = ''; // Clear loading

            if (!data.releases || data.releases.length === 0) {
                list.innerHTML = '<p>No official albums or EPs found for this artist.</p>';
                return;
            }

            data.releases.forEach(release => {
                const item = document.createElement('div');
                item.className = 'album-select-item';
                const releaseArtist = release['artist-credit']?.[0]?.name || artist;
                const releaseYear = (release.date || '----').split('-')[0];
                
                item.innerHTML = `
                    <div class="album-select-item-info">
                        <strong>${release.title}</strong>
                        <span>${releaseArtist} (${releaseYear})</span>
                    </div>
                    <button 
                        data-artist="${releaseArtist.replace(/"/g, '&quot;')}" 
                        data-title="${release.title.replace(/"/g, '&quot;')}" 
                        onclick="app.addAlbumFromSearch(this)">
                        Add
                    </button>
                `;
                list.appendChild(item);
            });

        } catch (e) {
            list.innerHTML = `<p style="color:var(--red);">Error searching for albums: ${e.message}</p>`;
        }
    },

    async addAlbumFromSearch(button) {
        const artist = button.dataset.artist;
        const title = button.dataset.title;

        button.disabled = true;
        button.textContent = 'Adding...';

        await this.findAndAddAlbum(artist, title);

        button.textContent = 'Added!';
    },

    closeAlbumSelectModal() {
        this.elements.albumSelectModal.style.display = 'none';
        this.elements.modalAlbumList.innerHTML = '';
    },


    // --- Google Sheet & API Processing ---
    async loadFromGoogleSheet() {
      const url = this.elements.sheetUrl.value;
      
      if (!url || !url.includes('/pub?') || !url.includes('output=tsv')) {
        this.setStatus("Error: Please paste your 'Publish to the web' .../pub?output=tsv link.");
        return;
      }
      
      this.setStatus("Fetching data from Google Sheet...");
      this.sheetQueue = [];
      this.clearFailedLog();

      try {
        const response = await fetch(url); 
        if (!response.ok) {
          throw new Error(`Could not access published sheet. (Status: ${response.status})`);
        }
        
        const tsvText = await response.text();
        const lines = tsvText.split(/\r?\n/).filter(Boolean);
        
        if (lines.length < 3) {
            throw new Error("Sheet is empty or has no data.");
        }

        const headers = lines[1].split('\t');
        const artistIndex = headers.indexOf("Artist");
        const albumIndex = headers.indexOf("Album");

        if (artistIndex === -1 || albumIndex === -1) {
          this.logFailed("Google Sheet", "", `Error: Your sheet MUST have columns named exactly "Artist" and "Album" (case-sensitive) on Row 2.`);
          this.setStatus("Error: Sheet columns not found. Check log.");
          return;
        }
        
        for (let i = 2; i < lines.length; i++) {
          const row = lines[i].split('\t');
          if (row[artistIndex] && row[albumIndex]) {
            this.sheetQueue.push({ artist: row[artistIndex], title: row[albumIndex] });
          }
        }
        this.setStatus(`Loaded ${this.sheetQueue.length} albums. Ready to find info.`);
      } catch (e) {
        console.error(e);
        this.setStatus(`Error: ${e.message}`);
        this.logFailed("Google Sheet", "", e.message);
      }
    },
    
    async processSheetQueue() {
        if (this.sheetQueue.length === 0) {
            this.setStatus("No albums in the queue. Load from Google Sheet first.");
            return;
        }
        
        const total = this.sheetQueue.length;
        for (let i = 0; i < total; i++) {
            const item = this.sheetQueue[i];
            this.setStatus(`Processing ${i + 1} of ${total}: ${item.artist} - ${item.title}`);
            
            const exists = this.db.some(a => a.artist === item.artist && a.title === item.title);
            if (exists) {
                this.logFailed(item.artist, item.title, "Already in collection, skipped.");
                continue;
            }
            
            try {
                await this.findAndAddAlbum(item.artist, item.title);
            } catch (e) {
                this.logFailed(item.artist, item.title, `Unexpected error: ${e.message}`);
            }
        }
        
        this.sheetQueue = [];
        this.setStatus(`Processing complete. ${total} albums processed.`);
        this.sortAndRender();
    },
    
    async findAndAddAlbum(artist, title) {
        const exists = this.db.some(a => a.artist === artist && a.title === title);
        if (exists) {
            this.logFailed(artist, title, "Already in collection, skipped.");
            return false;
        }

        try {
            const searchData = await api.searchRelease(artist, title);
            
            if (!searchData.releases || searchData.releases.length === 0) {
                this.logFailed(artist, title, "Not found on MusicBrainz.");
                return false;
            }

            const release = searchData.releases[0];
            const mbid = release.id;
            
            const mbArtist = release["artist-credit"]?.[0]?.name || artist;
            const mbTitle = release.title || title;
            const mbDate = release.date || "";

            const [coverArtUrl, releaseData] = await Promise.all([
                api.fetchCoverArtUrl(mbid),
                api.fetchReleaseDetails(mbid)
            ]);

            const tracks = [];
            releaseData.media?.forEach(m => {
                m.tracks?.forEach(t => {
                    tracks.push({ number: t.number, title: t.title });
                });
            });

            this.db.push({
                id: mbid,
                artist: mbArtist,
                title: mbTitle,
                date: mbDate,
                img: coverArtUrl,
                tracks: tracks
            });
            
            this.updateSaveStatus();
            this.sortAndRender();
            this.setStatus(`Added: ${mbArtist} - ${mbTitle}`);
            return true;
            
        } catch (e) {
            console.error(`Failed to fetch data for ${artist} - ${title}:`, e);
            this.logFailed(artist, title, e.message);
            return false;
        }
    },
    
    // --- NEW: Barcode Search Function ---
    async barcodeSearch() {
        const barcode = this.elements.barcodeInput.value.trim();
        if (!barcode) {
            this.setStatus("Please enter a barcode.");
            return;
        }

        this.setStatus(`Searching for barcode: ${barcode}...`);
        try {
            const data = await api.searchByBarcode(barcode);
            if (!data.releases || data.releases.length === 0) {
                this.setStatus(`Barcode not found: ${barcode}`);
                this.logFailed("Barcode Search", barcode, "Not found on MusicBrainz.");
                return;
            }

            // Get the first match
            const release = data.releases[0];
            const artist = release["artist-credit"]?.[0]?.name;
            const title = release.title;

            if (!artist || !title) {
                this.setStatus(`Could not find artist/title for barcode: ${barcode}`);
                return;
            }

            // Use our existing function to add it
            const success = await this.findAndAddAlbum(artist, title);
            if (success) {
                this.elements.barcodeInput.value = ''; // Clear input on success
            }
            
        } catch (e) {
            this.setStatus(`Error searching barcode: ${e.message}`);
            this.logFailed("Barcode Search", barcode, e.message);
        }
    },

    async manualSearch() {
        const artist = this.elements.artistInput.value.trim();
        const title = this.elements.albumInput.value.trim();
        
        if (artist && title) {
            this.setStatus(`Searching for: ${artist} - ${title}...`);
            const success = await this.findAndAddAlbum(artist, title);
            
            if (success) {
                this.elements.artistInput.value = '';
                this.elements.albumInput.value = '';
            } else {
                this.setStatus(`Could not add: ${artist} - ${title}. See log.`);
            }
        } else if (artist && !title) {
            this.setStatus(`Searching for albums by ${artist}...`);
            await this.showAlbumSearch(artist);
            this.elements.artistInput.value = '';
        } else {
            this.setStatus("Please enter at least an artist name.");
            return;
        }
    },

    sortAndRender() {
        this.sortDB();
        this.renderGrid();
        // Check if selectedIdx is still valid
        if (this.selectedIdx > -1 && this.selectedIdx < this.db.length) {
            this.selectAlbum(this.selectedIdx);
        } else {
            this.selectedIdx = -1; // Deselect if index is out of bounds
            this.renderSidebar();
        }
    },

    // --- Import / Export Functions ---
    exportDB() {
        if (this.db.length === 0) { alert('No data to export.'); return; }
        const json = JSON.stringify(this.db, null, 2);
        this.downloadFile(json, 'cd-collection.json', 'application/json');
        
        this.isDirty = false;
        this.elements.exportBtn.classList.remove('needs-save');
    },

    handleJSONUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (!Array.isArray(data)) throw new Error("Invalid JSON file.");
                this.db = data;
                this.sortAndRender();
                this.setStatus(`Imported ${this.db.length} albums from JSON.`);
                this.isDirty = false;
                this.elements.exportBtn.classList.remove('needs-save');
            } catch (err) {
                this.setStatus(`Import failed: ${err.message}`);
            }
            event.target.value = '';
        };
        reader.readAsText(file);
    },

    exportToCSV() {
        if (this.db.length === 0) { alert("No data to export."); return; }
        
        let csv = "Artist,Album,img,id,tracks,date\n";
        
        const escapeCSV = (field) => {
            if (field === null || field === undefined) field = "";
            let str = String(field);
            if (str.search(/("|,|\n)/g) >= 0) {
                str = `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        };

        this.db.forEach(c => {
            const tracksStr = c.tracks ? JSON.stringify(c.tracks) : "";
            const row = [
                c.artist,
                c.title,
                c.img,
                c.id,
                tracksStr,
                c.date
            ].map(escapeCSV).join(',');
            
            csv += row + "\n";
        });

        this.downloadFile(csv, 'cd-collection.csv', 'text/csv');
    },
    
    handleCSVUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const text = e.target.result;
                const rows = text.split(/\r?\n/).filter(Boolean);
                if (rows.length < 2) throw new Error("CSV is empty or has no headers.");

                const headers = rows.shift().split(',').map(h => h.trim().toLowerCase());
                const artistIdx = headers.indexOf('artist');
                const albumIdx = headers.indexOf('album');
                const imgIdx = headers.indexOf('img');
                const idIdx = headers.indexOf('id');
                const tracksIdx = headers.indexOf('tracks');
                const dateIdx = headers.indexOf('date');
                
                if (artistIdx === -1 || albumIdx === -1) {
                    throw new Error("CSV must have 'Artist' and 'Album' headers.");
                }

                const importedAlbums = [];
                rows.forEach(row => {
                    const cols = row.split(',');
                    const tracksJson = cols[tracksIdx] || "[]";
                    
                    importedAlbums.push({
                        artist: cols[artistIdx]?.trim() || "",
                        title: cols[albumIdx]?.trim() || "",
                        img: cols[imgIdx]?.trim() || "",
                        id: cols[idIdx]?.trim() || "",
                        tracks: JSON.parse(tracksJson.replace(/""/g, '"').replace(/^"|"$/g, '')),
                        date: cols[dateIdx]?.trim() || ""
                    });
                });
                
                let added = 0;
                importedAlbums.forEach(album => {
                    const exists = this.db.some(a => a.id === album.id || (a.artist === album.artist && a.title === album.title));
                    if (!exists) {
                        this.db.push(album);
                        added++;
                    }
                });
                
                this.sortAndRender();
                this.setStatus(`Imported ${added} new albums from CSV. ${importedAlbums.length - added} duplicates skipped.`);
                if (added > 0) {
                    this.updateSaveStatus();
                }
                
            } catch (err) {
                this.setStatus(`CSV Import failed: ${err.message}`);
                this.logFailed("CSV Import", "", err.message);
            }
            event.target.value = '';
        };
        reader.readAsText(file);
    },

    downloadFile(content, fileName, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    },
    
    // --- Init ---
    init() {
        this.renderGrid();
        this.renderSidebar();
        this.clearFailedLog();
        this.populateAZNav();
        
        this.isDirty = false;
        this.elements.exportBtn.classList.remove('needs-save');
        this.setStatus("App loaded. Import a JSON/CSV database or load from a Google Sheet.");
    }
};

// Start the app once the DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    app.init();
    
    window.addEventListener('beforeunload', (event) => {
        if (app.isDirty) {
            event.preventDefault();
            event.returnValue = '';
        }
    });
});

</script>
</body>
</html>